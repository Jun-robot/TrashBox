<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ブラウザメモ帳</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #333;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 800px;
      padding: 16px;
    }
    h1 {
      font-size: 1.6rem;
      margin: 0 0 12px;
      text-align: center;
    }
    .toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .toolbar input[type="text"] {
      flex: 1 1 200px;
      padding: 8px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .toolbar button {
      padding: 8px 12px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
    }
    .toolbar button.secondary {
      background: #757575;
    }
    textarea {
      width: 100%;
      height: calc(100vh - 170px);
      min-height: 200px;
      padding: 10px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      resize: vertical;
      line-height: 1.5;
    }
    .status {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #666;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ブラウザメモ帳</h1>
    <div class="toolbar">
      <input id="title" type="text" placeholder="タイトル (任意)">
      <button id="newNote" class="secondary">新規メモ</button>
      <button id="downloadNote">ダウンロード</button>
    </div>
    <textarea id="editor" placeholder="ここにメモを書いてください"></textarea>
    <div class="status" id="status"></div>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "browser-memo/current";

      const titleInput = document.getElementById("title");
      const editor = document.getElementById("editor");
      const status = document.getElementById("status");
      const newNoteBtn = document.getElementById("newNote");
      const downloadBtn = document.getElementById("downloadNote");

      function formatTime(date) {
        const pad = (n) => String(n).padStart(2, "0");
        return (
          date.getFullYear() +
          "-" +
          pad(date.getMonth() + 1) +
          "-" +
          pad(date.getDate()) +
          " " +
          pad(date.getHours()) +
          ":" +
          pad(date.getMinutes())
        );
      }

      function loadNote() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) {
            status.textContent = "未保存のメモ";
            return;
          }
          const data = JSON.parse(raw);
          titleInput.value = data.title || "";
          editor.value = data.content || "";
          if (data.updatedAt) {
            status.textContent = "自動保存: " + data.updatedAt;
          }
        } catch (e) {
          console.error("Failed to load memo", e);
          status.textContent = "読み込みに失敗しました";
        }
      }

      function saveNote() {
        const now = new Date();
        const payload = {
          title: titleInput.value,
          content: editor.value,
          updatedAt: formatTime(now),
        };
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
          status.textContent = "自動保存: " + payload.updatedAt;
        } catch (e) {
          console.error("Failed to save memo", e);
          status.textContent = "保存に失敗しました（容量オーバーかも）";
        }
      }

      let saveTimer = null;
      function scheduleSave() {
        status.textContent = "編集中…";
        if (saveTimer) {
          clearTimeout(saveTimer);
        }
        saveTimer = setTimeout(saveNote, 500);
      }

      titleInput.addEventListener("input", scheduleSave);
      editor.addEventListener("input", scheduleSave);

      newNoteBtn.addEventListener("click", () => {
        if (editor.value || titleInput.value) {
          const ok = window.confirm("現在のメモは上書きされます。続行しますか？");
          if (!ok) return;
        }
        titleInput.value = "";
        editor.value = "";
        status.textContent = "新しいメモ";
        saveNote();
      });

      downloadBtn.addEventListener("click", () => {
        const title = titleInput.value.trim() || "memo";
        const text = editor.value;
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = title + ".txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      loadNote();
    })();
  </script>
</body>
</html>
