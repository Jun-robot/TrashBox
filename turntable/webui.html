<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Turn Table Controller (Web Serial)</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --bg: radial-gradient(circle at 20% 20%, #f2f6ff 0, #eef2fb 25%, #e7ebf5 50%, #e1e6f2 75%, #dfe4f0 100%);
      --panel: #ffffff;
      --border: #d7dbe7;
      --text: #1f2743;
      --muted: #6b7590;
      --accent: #3b5bff;
      --accent-2: #19b1b8;
      --shadow: 0 14px 40px rgba(31, 39, 67, 0.12);
      --radius: 14px;
    }
    body {
      font-family: "Poppins", "Segoe UI", "Helvetica Neue", sans-serif;
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
    }
    .page {
      max-width: 1024px;
      margin: 32px auto 48px;
      padding: 0 20px;
      display: grid;
      gap: 16px;
    }
    .hero {
      background: linear-gradient(135deg, rgba(59, 91, 255, 0.15), rgba(25, 177, 184, 0.15));
      border: 1px solid rgba(59, 91, 255, 0.12);
      border-radius: 18px;
      padding: 18px 20px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .hero h1 { margin: 0; font-size: 22px; letter-spacing: 0.1px; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      border: 1px solid rgba(255,255,255,0.35);
      color: #0f1a3a;
      background: #fff;
    }
    section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: stretch;
    }
    .control { width: 100%; }
    label { display: block; margin: 0 0 6px; font-weight: 700; }
    input[type="number"] {
      width: 100%;
      max-width: 100%;
      padding: 10px 12px;
      font-size: 15px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f9fbff;
      color: var(--text);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }
    input[type="number"]:focus { outline: 2px solid rgba(59, 91, 255, 0.35); }
    button {
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 700;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease;
      box-shadow: 0 8px 20px rgba(31, 39, 67, 0.1);
      color: #fff;
      max-width: 100%;
    }
    button:active { transform: translateY(1px); }
    .primary { background: linear-gradient(135deg, #3b5bff, #19b1b8); }
    .ghost { background: #f1f3fb; color: var(--text); box-shadow: none; }
    .actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .hint { color: var(--muted); font-size: 13px; margin-top: 4px; }
    .tip { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .speed-box {
      max-width: 340px;
      width: 100%;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      margin-top: 10px;
    }
    .tip { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .speed-box {
      max-width: 340px;
      width: 100%;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      margin-top: 6px;
    }
    #log {
      height: 280px;
      overflow-y: auto;
      background: #0a0f1e;
      color: #dce6ff;
      padding: 10px;
      border-radius: 12px;
      font-family: "SFMono-Regular", Consolas, monospace;
      font-size: 13px;
      border: 1px solid #1d2740;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .tag { display: inline-block; padding: 3px 7px; border-radius: 8px; font-weight: 800; margin-right: 8px; letter-spacing: 0.2px; }
    .tx { background: rgba(59,91,255,0.18); color: #88a2ff; }
    .rx { background: rgba(25,177,184,0.2); color: #6cd5da; }
    .err { background: rgba(255,99,132,0.2); color: #ff9fb3; }
    .status-line { color: var(--muted); font-weight: 600; }

    @media (max-width: 720px) {
      .hero { flex-direction: column; align-items: flex-start; }
      .chips { width: 100%; justify-content: flex-start; }
      .controls { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="hero">
      <div>
        <h1>Turn Table Controller / Web Serial</h1>
        <div class="status-line" id="statusConn">未接続</div>
      </div>
      <div class="chips">
        <div class="chip" id="statusRun">停止中</div>
        <button class="ghost" id="btnConnect">接続</button>
      </div>
    </div>

    <section>
      <div class="controls">
        <div class="control">
          <label for="angle">角度 (度, 符号付き)</label>
          <input type="number" id="angle" value="90" step="1">
          <div class="hint" id="stepsHint">= 1600 steps</div>
        </div>
        <div class="control">
          <label for="count">送信回数（0で無限）</label>
          <input type="number" id="count" value="0" min="0" step="1">
        </div>
        <div class="control">
          <label for="interval">送信間隔 (ms)</label>
          <input type="number" id="interval" value="1000" min="50" step="10">
        </div>
        <div class="actions" style="margin-top:4px;">
          <button class="primary" id="btnStart">開始</button>
          <button class="ghost" id="btnStop" disabled>停止</button>
        </div>
      </div>
    </section>

    <section>
      <div style="font-weight:700; margin-bottom:8px;">ログ</div>
      <div id="log"></div>
      <div class="speed-box">
        <label for="period">スピード (ARR ticks, 400-65535)</label>
        <input type="number" id="period" value="400" min="400" max="65535" step="1">
        <div class="tip">PERIODコマンドで変更。停止中に送るのが無難です。</div>
        <div class="actions" style="margin-top:8px;">
          <button class="primary" id="btnSendPeriod">スピード送信</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    const MIN_INTERVAL_MS = 50;
    const encoder = new TextEncoder();

    const btnConnect = document.getElementById('btnConnect');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnSendPeriod = document.getElementById('btnSendPeriod');
    const statusConn = document.getElementById('statusConn');
    const statusRun = document.getElementById('statusRun');
    const angleInput = document.getElementById('angle');
    const countInput = document.getElementById('count');
    const intervalInput = document.getElementById('interval');
    const periodInput = document.getElementById('period');
    const logView = document.getElementById('log');
    const stepsHint = document.getElementById('stepsHint');

    let port = null;
    let reader = null;
    let writer = null;
    let readLoopActive = false;
    let sendTimerId = null;
    let lineBuffer = '';
    let running = false;
    let sendRemaining = Infinity;
    const STEPS_PER_90DEG = 50 * 32; // =1600
    const STEPS_PER_DEG = STEPS_PER_90DEG / 90.0;

    function appendLog(kind, text) {
      const tagClass = kind === 'TX' ? 'tx' : (kind === 'RX' ? 'rx' : 'err');
      const tagLabel = kind;
      const entry = document.createElement('div');
      const tag = document.createElement('span');
      tag.className = `tag ${tagClass}`;
      tag.textContent = tagLabel;
      const msg = document.createElement('span');
      msg.textContent = text;
      entry.appendChild(tag);
      entry.appendChild(msg);
      logView.appendChild(entry);
      logView.scrollTop = logView.scrollHeight;
    }

    function computeStepsFromAngle(angle) {
      return Math.round(angle * STEPS_PER_DEG);
    }

    function updateStepsHint() {
      const angle = parseFloat(angleInput.value);
      if (Number.isNaN(angle)) {
        stepsHint.textContent = '= --- steps';
        return;
      }
      const steps = computeStepsFromAngle(angle);
      stepsHint.textContent = `= ${steps} steps  (50*32 steps = 90°)`;
    }

    function setStatuses() {
      statusConn.textContent = port ? '接続中 (115200 8N1)' : '未接続';
      statusRun.textContent = running ? '送信中' : '停止中';
      btnStart.disabled = !port || running;
      btnStop.disabled = !port || !running;
      btnConnect.textContent = port ? '切断' : '接続';
    }

    async function connectSerial() {
      if (!('serial' in navigator)) {
        appendLog('ERR', 'このブラウザは Web Serial 非対応です');
        return;
      }
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        writer = port.writable.getWriter();
        reader = port.readable
          .pipeThrough(new TextDecoderStream())
          .getReader();
        startReadLoop();
        appendLog('RX', 'CONNECTED');
      } catch (e) {
        appendLog('ERR', `接続失敗: ${e.message}`);
        port = null;
      }
      setStatuses();
    }

    async function disconnectSerial() {
      stopSending();
      if (reader) {
        try { await reader.cancel(); } catch (e) {}
        try { reader.releaseLock(); } catch (e) {}
        reader = null;
      }
      if (writer) {
        try { writer.releaseLock(); } catch (e) {}
        writer = null;
      }
      if (port) {
        try { await port.close(); } catch (e) {}
        port = null;
      }
      appendLog('RX', 'DISCONNECTED');
      setStatuses();
    }

    async function startReadLoop() {
      if (!reader) return;
      readLoopActive = true;
      lineBuffer = '';
      try {
        while (readLoopActive) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) {
            lineBuffer += value;
            const parts = lineBuffer.split(/\r?\n/);
            lineBuffer = parts.pop();
            for (const line of parts) {
              if (line.trim().length > 0) appendLog('RX', line.trim());
            }
          }
        }
      } catch (e) {
        appendLog('ERR', `受信エラー: ${e.message}`);
      }
    }

    async function sendLine(text) {
      if (!writer) {
        appendLog('ERR', '未接続のため送信できません');
        return;
      }
      try {
        await writer.write(encoder.encode(text + '\n'));
        appendLog('TX', text);
      } catch (e) {
        appendLog('ERR', `送信エラー: ${e.message}`);
      }
    }

    function stopSending() {
      if (sendTimerId) {
        clearInterval(sendTimerId);
        sendTimerId = null;
      }
      running = false;
      setStatuses();
    }

    function startSending() {
      if (!port || !writer) {
        appendLog('ERR', '未接続です');
        return;
      }
      const angle = parseFloat(angleInput.value);
      const count = parseInt(countInput.value, 10);
      const interval = parseInt(intervalInput.value, 10);
      if (Number.isNaN(angle)) {
        appendLog('ERR', '角度が不正です');
        return;
      }
      const steps = computeStepsFromAngle(angle);
      if (steps === 0) {
        appendLog('ERR', '角度が小さすぎます (ステップ数が0)');
        return;
      }
      if (Number.isNaN(count) || count < 0) {
        appendLog('ERR', '送信回数は0以上を指定してください');
        return;
      }
      if (Number.isNaN(interval) || interval < MIN_INTERVAL_MS) {
        appendLog('ERR', `送信間隔は ${MIN_INTERVAL_MS}ms 以上にしてください`);
        return;
      }
      stopSending(); // 重複開始防止
      sendRemaining = (count === 0) ? Infinity : count;
      const cmd = `MOVE ${steps}`;
      const sendOnce = () => {
        if (sendRemaining === 0) {
          stopSending();
          return;
        }
        sendLine(cmd);
        if (sendRemaining !== Infinity) {
          sendRemaining -= 1;
          if (sendRemaining <= 0) {
            stopSending();
            return;
          }
        }
      };
      sendOnce(); // すぐ1回送る
      sendTimerId = setInterval(sendOnce, interval);
      running = true;
      setStatuses();
    }

    btnConnect.addEventListener('click', () => {
      if (port) disconnectSerial();
      else connectSerial();
    });

    angleInput.addEventListener('input', updateStepsHint);
    btnStart.addEventListener('click', startSending);
    btnStop.addEventListener('click', stopSending);
    btnSendPeriod.addEventListener('click', () => {
      if (!port || !writer) {
        appendLog('ERR', '未接続です');
        return;
      }
      const periodStr = periodInput.value.trim();
      const period = periodStr === '' ? NaN : parseInt(periodStr, 10);
      if (Number.isNaN(period) || period < 400 || period > 65535) {
        appendLog('ERR', 'スピード(ARR)は 400〜65535 の範囲で指定してください');
        return;
      }
      sendLine(`PERIOD ${period}`);
    });

    setStatuses();
    updateStepsHint();
    if (!('serial' in navigator)) {
      appendLog('ERR', 'このブラウザは Web Serial API をサポートしていません');
      btnConnect.disabled = true;
      btnStart.disabled = true;
      btnStop.disabled = true;
    }
  </script>
</body>
</html>
